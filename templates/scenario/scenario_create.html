{% load crispy_forms_tags %}

<div id="CreateScenarioModal" class="modal fade">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title">Create New Scenario</h1>
            </div>
            <div class="modal-body">
                <form id="CreateScenarioForm" method="POST">
                    {% csrf_token %}
                    <div id="FormGroup" class="form-group">
                        {{ form| crispy }}
                    </div>
                    <button class="btn btn-success" type="submit">Create</button>
                </form>
            </div>
            <div class="modal-footer">
                <!-- Here we create this empty div for alert messages -->
                <div style="float: left; margin: 5px;" id="message-div"></div>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script>
    $(function () {
        $("#id_start_date").datepicker({
            format: 'dd/mm/yyyy',
        });
    });
</script>

<script>
  /*
    function getFormData($form){
    var unindexed_array = $form.serializeArray();
    var indexed_array = {};

    $.map(unindexed_array, function(n, i){
        indexed_array[n['name']] = n['value'];
    });
    return indexed_array;
    }
*/

    var form_id = $("#CreateScenarioForm");

    form_id.on('submit', function (event) {
        event.preventDefault();
        console.log(getFormData(form_id));
        console.log("form submitted!")  // sanity check
        create_scenario();
    });


    {#// AJAX for posting#}

    function create_scenario() {
        $.ajax({
            url: "{% url 'scenario_create_post' %}",
            type: "POST",
            data: form_id.serialize(),
            success: function (data) {
                if (!(data['success'])) {
                    console.log("form errors!")
                    // Here we replace the form, for the errors to show
                    form_id.find($("#FormGroup")).replaceWith($(data['form_html']));

                } else {
                    console.log("success!")
                    //Remove fields to prevent accidental resubmission
                    {% for field in form %}
                        $('#' + '{{ field.auto_id}}').val(''); // remove the values from the inputs
                    {% endfor %}
                    //Show the success message
                    $('#message-div').html("<div class='alert-success'>" +
                        "<strong>Success: </strong>New scenario was created </div>");
                    //location.reload();
                }
            },
            error: function (xhr, errmsg) {
                console.log("backend_error!")
                //Show the error message
                $('#message-div').html("<div class='alert-error'>" +
                    "<strong>Success: </strong> We have encountered an error: " + errmsg + "</div>");
            }
        });


    };

    //Reload page when modal closes
    $('#CreateScenarioModal').on('hide.bs.modal', function () {
        console.log("reload!")  // sanity check
        location.reload();

    });

    function getFormData($form) {
        var unindexed_array = $form.serializeArray();
        var indexed_array = {};

        $.map(unindexed_array, function (n, i) {
            indexed_array[n['name']] = n['value'];
        });

        return indexed_array;
    }

    {#// AJAX for posting#}
    {#function create_scenario() {#}
    {#    console.log("create scenario is working!") // sanity check#}
    {#    var form_data = {};#}
    {##}
    {#    {% for field in form %}#}
    {#        form_data['{{ field.name}}'] = $('#' + '{{ field.auto_id}}').val();#}
    {#    {% endfor %}#}
    {##}
    {#    console.log(form_data);#}
    {##}
    {##}
    {#    $.ajax({#}
    {#        headers: { "X-CSRFToken": '{{ csrf_token }}' },#}
    {#        url: "{% url 'scenario_create' %}", // the endpoint#}
    {#        type: "POST", // http method#}
    {#        data: form_data, // data sent with the post request#}
    {##}
    {#        // handle a successful response#}
    {#        success: function (json) {#}
    {#            {% for field in form %}#}
    {#                $('#' + '{{ field.auto_id}}').val(''); // remove the values from the inputs#}
    {#            {% endfor %}#}
    {#            console.log(json); // log the returned json to the console#}
    {#            console.log("success"); // another sanity check#}
    {#        },#}
    {##}
    {#        // handle a non-successful response#}
    {#        error: function (xhr, errmsg, err) {#}
    {#            $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: " + errmsg +#}
    {#                " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom#}
    {#            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console#}
    {#        }#}
    {#    });#}
    {#    };#}

</script>