{% extends 'base.html' %}

{% load crispy_forms_tags %}

{% block start_body_scripts %}
    <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
    <script src="/static/js/selectize.js"></script>

{% endblock start_body_scripts %}

{% block content %}
    <div class="row mb-4">

<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4" id='economicDataDiv'></div>
</div>

<div class="row mb-4">
    <label for="select-diagrams1">Select diagrams to draw:</label>
    <input type="text" id="select-diagrams1" class="select-diagrams" onchange="reloadDiagrams(this.value)"/>
</div>

    <div class="mb-4" id='graphDiv'></div>


{% endblock content %}


{% block end_body_scripts %}
    <script>
        $('#economicDataDiv').ready(function () {
            $.ajax({
                url: "{% url 'scenario_economic_results' scenario_id %}",
                type: "GET",
                success: data => data.map(dataObj => drawPieChart(dataObj)),
                error: function (xhr, errmsg) {
                    console.log("backend_error!")
                    //Show the error message
                    $('#message-div').html("<div class='alert-error'>" +
                        "<strong>Success: </strong> We have encountered an error: " + errmsg + "</div>");
                }
            });
        });

        function drawPieChart(dataList) {
            const data = [{
                values: [19, 26, 55], // dataList.values
                labels: ['Residential', 'Non-Residential', 'Utility'], // dataList.labels
                type: 'pie',
                textinfo: "label+percent",
                textposition: "inside",
                automargin: true
            }];

            const layout = {
                title:'Economic Data', // dataList.title
                height: 300,
                width: 300,
                margin: {"b": 0, "l": 0, "r": 0},
                showlegend: false,
                paper_bgcolor: "transparent"
            }

            // Create a new Pie under the economic data div
            const parentDiv = document.getElementById("economicDataDiv");
            const newGraph = document.createElement('div');
            newGraph.id = "pie"+layout.title.replace(' ', '');
            parentDiv.appendChild(newGraph);
            Plotly.newPlot(newGraph.id, data, layout);
        }
    </script>



    <script>
        // Ajax request to retrieve all available graphs for visualization
        $(document).ready(function () {
            getEnergyVectorAvailableResults("Electricity", '#select-diagrams1');
        });

        function getEnergyVectorAvailableResults(energyVector, selectizeId) {
            // make an Ajax request for the TimeSeries Graphs
            $.ajax({
                url: "{% url 'scenario_available_results' scenario_id %}",
                type: "GET",
                data: {"energy_vector":energyVector},
                success: data => initiateSelectize(data.options.flat(), data.optgroups, selectizeId),
                error: function (xhr, errmsg) {
                    console.log("backend_error!")
                    //Show the error message
                    $('#message-div').html("<div class='alert-error'>" +
                        "<strong>Success: </strong> We have encountered an error: " + errmsg + "</div>");
                }
            });
        }

        // region TimeSeries Graphs
        function initiateSelectize(options, optgroups, selectizeId) {
            $(selectizeId).selectize({
                persist: false,
                maxItems: null,
                valueField: 'assetName',
                labelField: 'assetName',
                searchField: ['assetCategory', 'assetName'],
                // this is where you are returning the data from your JSON file
                options: options,
                optgroups: optgroups,
                optgroupField: 'assetCategory', // refers to the group field in "options"
                optgroupLabelField: 'assetCategory', // refers to the label field in "optgroups"
                optgroupValueField: 'assetCategory', // refers to the value field in "optgroups"

            });
        }

        // On change reload diagrams
        function reloadDiagrams(assetNameList) {
            // Ajax request to retrieve requested graph data
            $.ajax({
                url: "{% url 'scenario_request_results' scenario_id %}",
                type: "GET",
                data: {
                    assetNameList: assetNameList,
                },
                success: data => drawScatterGraph(data),
                error: function (xhr, errmsg) {
                    console.log("backend_error!")
                    //Show the error message
                    $('#message-div').html("<div class='alert-error'>" +
                        "<strong>Success: </strong> We have encountered an error: " + errmsg + "</div>");
                }
            });
        }

        function drawScatterGraph(dataList) {

            const traceList = [];

            dataList.map(async data => {
                const trace = {
                    name: data.title,
                    x: data.xAxis.values,
                    y: data.yAxis.values,
                    type: 'scatter'
                };

                traceList.push(trace)
            });

            const layout = {
                title: dataList[0].title,
                xaxis: {
                    title: dataList[0].xAxis.label,
                    showgrid: true,
                    zeroline: true
                },
                yaxis: {
                    title: dataList[0].yAxis.label,
                    showline: true
                },
                autosize: true,
                width: 1500,
                height: 750,
                margin: {
                    l: 50,
                    r: 50,
                    b: 100,
                    t: 100,
                    pad: 4
                },
                //paper_bgcolor: '#7f7f7f',
                //plot_bgcolor: '#c7c7c7'
            };


            Plotly.newPlot('graphDiv', traceList, layout, {responsive: true});
        }
        // endregion
    </script>


{% endblock end_body_scripts %}