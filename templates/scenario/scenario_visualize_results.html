{% extends 'base.html' %}

{% load crispy_forms_tags %}

{% block start_body_scripts %}
    <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
        <script src="/static/js/selectize.js"></script>

{% endblock start_body_scripts %}

{% block content %}
    <div class="mb-4">
        <label for="select-diagrams">Select diagrams to draw:</label>
        <input type="text" id="select-diagrams"/>
    </div>

    <div class="mb-4" id='myDiv'></div>

{% endblock content %}


{% block end_body_scripts %}

    <script>

        var REGEX_EMAIL = '([a-z0-9!#$%&\'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&\'*+/=?^_`{|}~-]+)*@' +
            '(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?)';

        $('#select-diagrams').selectize({
            persist: false,
            maxItems: null,
            valueField: 'email',
            labelField: 'name',
            searchField: ['name', 'email'],
            options: [
                {email: 'brian@thirdroute.com', name: 'Brian Reavis'},
                {email: 'nikola@tesla.com', name: 'Nikola Tesla'},
                {email: 'someone@gmail.com'}
            ],
            render: {
                item: function (item, escape) {
                    return '<div>' +
                        (item.name ? '<span class="name">' + escape(item.name) + '</span>' : '') +
                        (item.email ? '<span class="email">' + escape(item.email) + '</span>' : '') +
                        '</div>';
                },
                option: function (item, escape) {
                    var label = item.name || item.email;
                    var caption = item.name ? item.email : null;
                    return '<div>' +
                        '<span class="label">' + escape(label) + '</span>' +
                        (caption ? '<span class="caption">' + escape(caption) + '</span>' : '') +
                        '</div>';
                }
            },
            createFilter: function (input) {
                var match, regex;

                // email@address.com
                regex = new RegExp('^' + REGEX_EMAIL + '$', 'i');
                match = input.match(regex);
                if (match) return !this.options.hasOwnProperty(match[0]);

                // name <email@address.com>
                regex = new RegExp('^([^<]*)\<' + REGEX_EMAIL + '\>$', 'i');
                match = input.match(regex);
                if (match) return !this.options.hasOwnProperty(match[2]);

                return false;
            },
            create: function (input) {
                if ((new RegExp('^' + REGEX_EMAIL + '$', 'i')).test(input)) {
                    return {email: input};
                }
                var match = input.match(new RegExp('^([^<]*)\<' + REGEX_EMAIL + '\>$', 'i'));
                if (match) {
                    return {
                        email: match[2],
                        name: $.trim(match[1])
                    };
                }
                alert('Invalid email address.');
                return false;
            }
        });

    </script>


    <script>
        const plotTime = {{ tTime }};

        function convertToDateTime(unixTimestamp) {
            const newDate = new Date(unixTimestamp);
            return newDate;
        }

        plotTime.forEach(function (timeStamp, index) {
            this[index] = convertToDateTime(timeStamp);
        }, plotTime);

        var trace3 = {
            x: plotTime,
            y: {{ tData }},
            type: 'scatter'
        };

        var layout = {
            title: 'energyProduction',
            xaxis: {
                title: 'DateTime',
                showgrid: true,
                zeroline: true
            },
            yaxis: {
                title: 'Electricity',
                showline: true
            }
        };

        //var data = [trace1, trace2];
        var data = [trace3];
        Plotly.newPlot('myDiv', data, layout);
    </script>
{% endblock end_body_scripts %}