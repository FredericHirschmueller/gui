{% extends 'base.html' %}

{% load crispy_forms_tags %}

{% block start_body_scripts %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.css">
    <link rel="stylesheet" type="text/css" href="/static/css/beautiful.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ=" crossorigin="anonymous" />
{% endblock start_body_scripts %}

{% block topology %}
    <div class="wrapper">

        <div id="accordion" class="col">
            <h3>Energy Production</h3>
            <ul style="list-style-type: none;padding: 0;">
                <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="dso_consumption">
                    <i class="fas fa-plug"></i><span> DSO Consumption </span>
                </li>
                <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="pv_plant">
                    <i class="fas fa-solar-panel"></i><span> PV Plant </span>
                </li>
                <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="wind_plant">
                    <i class="fas fa-wind"></i><span> Wind Plant </span>
                </li>
                <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="dso">
                    <i class="fas fa-grip-lines"></i><span> System DSO </span>
                </li>
            </ul>
            <h3>Energy Conversion</h3>
            <ul style="list-style-type: none;padding: 0;">
                <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="transformer_station_in">
                    <i class="fas fa-arrow-left"></i><span> Transformer Station In </span>
                </li>
                <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="transformer_station_out">
                    <i class="fas fa-arrow-right"></i><span> Transformer Station Out </span>
                </li>
                <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="storage_charge_controller_in">
                    <i class="fas fa-charging-station"></i> <i class="fas fa-long-arrow-alt-left"></i><span> Storage Charge Controller In </span>
                </li>
                <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="storage_charge_controller_out">
                    <i class="fas fa-charging-station"></i> <i class="fas fa-long-arrow-alt-right"></i><span> Storage Charge Controller Out </span>
                </li>
                <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="solar_inverter">
                    <i class="fas fa-solar-panel"></i> <i class="fas fa-arrows-alt"></i><span> Solar Inverter </span>
                </li>
            </ul>
            <h3>Energy Storage</h3>
            <ul style="list-style-type: none;padding: 0;">
                <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="charging_power">
                    <i class="fas fa-battery-three-quarters"></i><span> Charging Power </span>
                </li>
                <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="discharging_power">
                    <i class="fas fa-battery-quarter"></i><span> Discharging Power </span>
                </li>
                <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="capacity">
                    <i class="fas fa-battery-full"></i><span> Capacity </span>
                </li>
                <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="storage_unit">
                    <i class="fas fa-car-battery"></i><span> Storage </span>
                </li>
            </ul>
            <h3>Energy Consumption</h3>
            <ul style="list-style-type: none;padding: 0;">
                <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="electricity_excess">
                    <i class="fas fa-fire"></i><span> Electricity Excess </span>
                </li>
                <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="dso_feedin">
                    <i class="fas fa-plug"></i><span> DSO Feedin </span>
                </li>
                <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="demand">
                    <i class="fas fa-lightbulb"></i><span> Demand </span>
                </li>
            </ul>
            <h3>Energy Bus</h3>
            <ul style="list-style-type: none;padding: 0;">
                <li>
                    <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="bus">
                        <i class="fas fa-grip-lines"></i><span> Bus </span>
                    </div>
                </li>
            </ul>
        </div>

        <div class="col-center">
            <div class="menu">
                <ul><li onclick="editor.changeModule('Home'); changeModule(event);" class="selected">Topology</li></ul>
            </div>

            <div id="drawflow" ondrop="drop(event)" ondragover="allowDrop(event)">
                <div class="btn-export">Save</div>
                <div class="btn-clear" onclick="editor.clearModuleSelected()">Clear</div>
            </div>
        </div>

        <!--
        <div class="col-right" style="display: none">
            Add here logic for the properties sidebar.
        </div>
        -->
    </div>

{% endblock topology %}


{% block end_body_scripts %}
    <script src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.serializeJSON/3.1.0/jquery.serializejson.min.js" integrity="sha512-4y8bsEzrXJqRyl2dqjdKk/DetH59JcFTtYNMsy5DUpvVV8CXiSrQ1gSCL3+dFgj1Xco0ONPizsYd6wX2eAXL2g==" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        $( function() {
            $( "#accordion" ).accordion();
        } );
    </script>

    <script>
        const addBusses = async (data) =>
            await Promise.all(data.map(async nodeData =>
                createNodeObject(nodeData.name, nodeData.input_ports, nodeData.output_ports, nodeData.data, nodeData.pos_x, nodeData.pos_y)));

        const addAssets = async (data) =>
            await Promise.all(data.map(async nodeData =>
                createNodeObject(nodeData.name, 1, 1, nodeData.data, nodeData.pos_x, nodeData.pos_y)));

        const addLinks = async (data) => data.map(async linkData => {
            let busNodeId = nodeToDbId['bus'][linkData.bus_id];
            let assetNodeId = nodeToDbId['asset'][linkData.asset_id];
            (linkData.flow_direction === "B2A") ?
                editor.addConnection(busNodeId, assetNodeId, linkData.bus_connection_port, 'input_1')
                : editor.addConnection(assetNodeId, busNodeId, 'output_1', linkData.bus_connection_port);
        });


        $(window).on('load', function() {
            $.getJSON("{% url 'new_assets_topology' scenario_id %}", {}, async (data, textStatus, jqXHR) => {
                $.when(addBusses(data['busses']), addAssets(data['assets']))
                    .then(async () => addLinks(data['links'])); // endwhen
                return data;
            })
            .done(function (data) { /*console.log(`Finished loading nodes and links! ${JSON.stringify(data)}`);*/ })
            .fail(function (jqxhr,settings,ex) { alert('failed, '+ ex); });
        });
    </script>

    <script>
        // Initialize
        var id = document.getElementById("drawflow");
        const editor = new Drawflow(id);
        editor.reroute = true;
        editor.start();

        /* Mouse and Touch Actions */
        var elements = document.getElementsByClassName('drag-drawflow');
        for (var i = 0; i < elements.length; i++) {
            elements[i].addEventListener('touchend', drop, false);
            elements[i].addEventListener('touchmove', positionMobile, false);
            elements[i].addEventListener('touchstart', drag, false );
        }

        var mobile_item_selec = '';
        var mobile_last_move = null;
        function positionMobile(ev) {
            mobile_last_move = event;
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            if (ev.type === "touchstart") {
                mobile_item_selec = ev.target.closest(".drag-drawflow").getAttribute('data-node');
            } else {
                ev.dataTransfer.setData("node", ev.target.getAttribute('data-node'));
            }
        }

        function drop(ev) {
            if (ev.type === "touchend") {
                const parentdrawflow = document.elementFromPoint(mobile_last_move.touches[0].clientX, mobile_last_move.touches[0].clientY).closest("#drawflow");
                if(parentdrawflow != null) {
                    addNodeToDrawFlow(mobile_item_selec, mobile_last_move.touches[0].clientX, mobile_last_move.touches[0].clientY);
                }
                mobile_item_selec = '';
            } else {
                ev.preventDefault();
                const nodeName = ev.dataTransfer.getData("node");
                (nodeName === "bus") ? IOBusOptions(nodeName, ev.clientX, ev.clientY) :
                    (nodeName === "storage_unit") ? addStorageUnit(nodeName, ev.clientX, ev.clientY) : addNodeToDrawFlow(nodeName, ev.clientX, ev.clientY);
            }
        }


        // region create Storage Unit - template
        const addStorageUnit = async (nodeName /* i.e. storage_unit */, clientX, clientY) => {
            //TODO: Consider using the following implementation if multiple templates are required.
               // Alternative Solution: Create a template using the UI and export the JSON.
               // Hardcode the JSON in separate file or here and parametrize.
               // Finally Use async/await and addBusses(), addAssets(), addLinks() functions to show template.

            const storageUnitData = {"busses":[
                    {"name":"bus","data":{"name":"storage bus","bustype":"bus_electricity"},
                        "pos_x":clientX,"pos_y":clientY,"input_ports":1,"output_ports":2}],
                "assets":[
                    {"name":"charging_power","pos_x":clientX+100,"pos_y":clientY+20,"data":{}},
                    {"name":"discharging_power","pos_x":clientX+100,"pos_y":clientY+80,"data":{}},
                    {"name":"capacity","pos_x":clientX-150,"pos_y":clientY+50,"data":{}}],
                "links":[
                    {"bus_id":null,"asset_id":null,"flow_direction":"B2A","bus_connection_port":"output_1"},
                    {"bus_id":null,"asset_id":null,"flow_direction":"B2A","bus_connection_port":"output_2"},
                    {"bus_id":null,"asset_id":null,"flow_direction":"A2B","bus_connection_port":"input_1"}]};

            const busses_ids = await addBusses(storageUnitData['busses']);
            const assets_ids = await addAssets(storageUnitData['assets']);
            console.log(busses_ids[0]);
            assets_ids.map(id => {
                const nodeObj = document.getElementById("node-"+id);
                console.log(nodeObj.classList);
            });
            //$.when(addBusses(storageUnitData['busses']), addAssets(storageUnitData['assets']))
              //      .then(async () => addLinks(storageUnitData['links']));

            /*
            const storageBusNodeId = await addNodeToDrawFlow("bus", clientX, clientY, 2, 1);
            const storageChargingPowerId = await addNodeToDrawFlow("charging_power", clientX+100, clientY+20, 1, 1);
            const storageDischargingPowerId = await addNodeToDrawFlow("discharging_power", clientX+100, clientY+80, 1, 1);
            const storageCapacityId = await addNodeToDrawFlow("capacity", clientX-150, clientY+50, 0, 1);

            // Add Connections between Nodes.
            editor.addConnection(storageChargingPowerId, storageBusNodeId, 'output_1', 'input_1');
            editor.addConnection(storageBusNodeId, storageDischargingPowerId, 'output_1', 'input_1');
            editor.addConnection(storageCapacityId, storageBusNodeId, 'output_1', 'input_2');
            */
        }
        // endregion create Storage Unit - template


        function IOBusOptions(nodeName, posX, posY) {
            const checkMinMax = (value, min, max) => (value <= min) ? min : (value >= max) ? max : value;
            Swal.mixin({
                input: 'number',
                confirmButtonText: 'Next',
                showCancelButton: true,
                progressSteps: ['1', '2']
            })
                .queue([
                {
                    title: 'Bus Inputs',
                    text: 'Provide the number of bus Inputs (default 1)',
                    //html: '<div>Testing Here</div>'
                },
                {
                    title: 'Bus Outputs',
                    text: 'Provide the number of bus Outputs (default 1)',
                }
            ])
                .then((result) => {
                if (result.value) {
                    const inputs =  checkMinMax(result.value[0], 1, 7);
                    const outputs = checkMinMax(result.value[1], 1, 7);
                    addNodeToDrawFlow(nodeName, posX, posY, inputs, outputs);
                }
            })
        }

        // Disallow Any Connection to be created without a bus.
        editor.on('connectionCreated', function(connection) {
            var nodeIn = editor.getNodeFromId(connection['input_id']);
            var nodeOut = editor.getNodeFromId(connection['output_id']);
            if ((nodeIn['name'] !== 'bus' && nodeOut['name'] !== 'bus') || (nodeIn['name'] === 'bus' && nodeOut['name'] === 'bus')) {
                editor.removeSingleConnection(connection['output_id'],connection['input_id'],connection['output_class'],connection['input_class']);
                Swal.fire('Unexpected Connection', 'Please connect assets to each other\n only through a bus node. Interconnecting busses is also not allowed.', 'error')
            }
        })

        const nodeToDbId = {'bus':{},'asset':{}}; // a dictionary to keep the mapping between node and database ids.

        editor.on('nodeCreated', function (nodeID){
            const nodeType = (editor.drawflow.drawflow.Home.data[`${nodeID}`].name === "bus") ? "bus" : "asset";
            const dbId = editor.drawflow.drawflow.Home.data[`${nodeID}`]['data']['databaseId'];
            if (nodeType === "bus")
                nodeToDbId['bus'][`${dbId}`] = nodeID;
            else
                nodeToDbId['asset'][`${dbId}`] = nodeID;
        })

        async function addNodeToDrawFlow(name, pos_x, pos_y, nodeInputs = 1, nodeOutputs = 1, nodeData = {}) {
            if(editor.editor_mode === 'fixed')
                return false;
            pos_x = pos_x * ( editor.precanvas.clientWidth / (editor.precanvas.clientWidth * editor.zoom)) - (editor.precanvas.getBoundingClientRect().x * ( editor.precanvas.clientWidth / (editor.precanvas.clientWidth * editor.zoom)));
            pos_y = pos_y * ( editor.precanvas.clientHeight / (editor.precanvas.clientHeight * editor.zoom)) - (editor.precanvas.getBoundingClientRect().y * ( editor.precanvas.clientHeight / (editor.precanvas.clientHeight * editor.zoom)));
            return createNodeObject(name, nodeInputs, nodeOutputs, {}, pos_x, pos_y);
        }

        // region Show Modal either by double clicking the box or the drawflow node.
        var transform = '';
        function openModal(box) {
            box.closest(".drawflow-node").style.zIndex = "9999";
            box.children[0].style.display = "block";
            transform = editor.precanvas.style.transform;
            editor.precanvas.style.transform = '';
            editor.precanvas.style.left = editor.canvas_x +'px';
            editor.precanvas.style.top = editor.canvas_y +'px';
            editor.editor_mode = "fixed";
        }

        const showpopup = (e) => openModal(e.target);

        document.addEventListener("dblclick", function (e) {
            const NodeList = document.getElementsByClassName("drawflow-node");
            for (const node of NodeList) {
                if (e.target === node) {
                    const box = e.target.querySelector('.drawflow-node .box');
                    openModal(box);
                }
            }
        });
        // endregion

        // region close Modal on: 1. click 'x', 2. press 'esc' and 3. click outside the modal.
        function closeModalSteps(modal) {
            modal.style.display  ="none"; // hide the modal
            modal.closest(".drawflow-node").style.zIndex = "2"; // bring node to default z-index
            editor.precanvas.style.transform = transform;
            editor.precanvas.style.left = '0px';
            editor.precanvas.style.top = '0px';
            editor.editor_mode = "edit";
        }

        const closemodal = (e) => closeModalSteps(e.target.closest(".modal"));

        document.addEventListener('keydown', function(e) {
            const modalList = document.getElementsByClassName("modal");
            if (e.keyCode === 27) {
                for (let modalDiv of modalList) {
                    if (modalDiv.style.display === "block")
                        closeModalSteps(modalDiv);
                }
            }
        })

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(e) {
            const modalList = document.getElementsByClassName("modal");
            for (const modalDiv of modalList) {
                if (e.target === modalDiv && modalDiv.style.display === "block")
                    closeModalSteps(modalDiv);
            }
        }
        // endregion set
    </script>


    <script>
        async function createNodeObject(nodeName, connectionInputs=1, connectionOutputs=1, nodeData={}, pos_x, pos_y) {
            if (nodeName === "bus"){
                const shownName = (typeof nodeData.name === 'undefined') ? nodeName : nodeData.name;
                let html = `<div class="box" ondblclick="showpopup(event)">${shownName}
                <div class="modal" style="display:none">
                  <div class="modal-content">
                    <span class="close" onclick="closemodal(event)">&times;</span>
                    <h2 style="color: grey; text-align: left">${nodeName} Data</h2>
                    <div>
                        <label for="name">Name: </label>
                        <input id="name" type="text" df-name>
                    </div>
                    <div>
                        <label for="bustype">Bus Type: </label>
                        <select id="bustype" df-bustype>
                            <option value="" selected disabled hidden>Choose Type...</option>
                            <option value="bus_electricity">Electricity Bus</option>
                            <option value="bus_heat">Heat Bus</option>
                            <option value="bus_gas">Gas Bus</option>
                        </select>
                    </div>
                  </div>
                </div>
            </div>`;
                return editor.addNode(nodeName, connectionInputs, connectionOutputs, pos_x, pos_y, nodeName, nodeData, html);
            }
            else
                return fetchAssetForm(nodeName, connectionInputs, connectionOutputs, nodeData, pos_x, pos_y);
        }

        async function fetchAssetForm(nodeName, connectionInputs=1, connectionOutputs=1, nodeData, pos_x, pos_y) {
            // Due to a problem with Boolean Values not showing in the modal we have to convert bool to string.
            nodeData.optimize_cap = (nodeData.optimize_cap) ? "True" : "False";
            nodeData.dispatchable = (nodeData.dispatchable) ? "True" : "False";
            // ------------------------------------------------------------------------------------------------
            const fullUrl = document.location.origin+'/asset/create/'+nodeName;

            const resp = await fetch(fullUrl);
            const data = await resp.text();
            const formData = data.substring(data.indexOf("<form "), data.indexOf("</form>") + 7);

            const shownName = (typeof nodeData.name === 'undefined') ? nodeName : nodeData.name;
            const source_html = `<div class="box" ondblclick="showpopup(event)">${shownName}
                <div class="modal" style="display:none">
                  <div class="modal-content">
                    <span class="close" onclick="closemodal(event)">&times;</span>
                    <h2 style="color: grey; text-align: left">${nodeName.replace("_"," ")} Data</h2>
                    <div>${formData}</div>
                  </div>
                </div>
            </div>`;
            return editor.addNode(nodeName, connectionInputs, connectionOutputs, pos_x, pos_y, nodeName, nodeData, source_html);
        }
    </script>

    <script defer>
        /* Export Topology to JSON and send to back-end. */
        $(".btn-export").click(function(){
            console.log(JSON.stringify(editor.export()));
            $.ajax({
                headers: {'X-CSRFToken': '{{ csrf_token }}' },
                type: "POST",
                url: "{% url 'new_assets_topology' scenario_id %}",
                data: JSON.stringify(editor.export()),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(resp){
                    var node = resp.data;
                    $.each(node, function(key, val){
                        // add database id to the node data dictionary, in order to discriminate among existing and new nodes.
                        editor.drawflow.drawflow.Home.data[`${key}`].data['databaseId'] = val;
                    });
                    window.location.href = "{% url 'scenario_search' project_id %}";
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    Swal.fire('Grid Model Error', `Please fill in all ${XMLHttpRequest.responseJSON.obj_type} fields.`, 'error');
                }
            });
        });
    </script>

{% endblock end_body_scripts %}
