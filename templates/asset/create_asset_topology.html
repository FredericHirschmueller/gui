{% extends 'base.html' %}

{% load crispy_forms_tags %}

{% block start_body_scripts %}
    <script src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.css">
    <link rel="stylesheet" type="text/css" href="/static/css/beautiful.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ=" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.serializeJSON/3.1.0/jquery.serializejson.min.js" integrity="sha512-4y8bsEzrXJqRyl2dqjdKk/DetH59JcFTtYNMsy5DUpvVV8CXiSrQ1gSCL3+dFgj1Xco0ONPizsYd6wX2eAXL2g==" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        $( function() {
            $( "#accordion" ).accordion();
        } );
    </script>
{% endblock start_body_scripts %}

{% block topology %}
    <div class="wrapper">

        <div id="accordion" class="col">
            <h3>Energy Production</h3>
            <div style="padding: 0px; margin: 0px; height: fit-content;">
                <div class="drag-drawflow source" draggable="true" ondragstart="drag(event)" data-node="dso_consumption">
                    <i class="fas fa-plug"></i><span> DSO Consumption </span>
                </div>
                <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="pv_plant">
                    <i class="fas fa-solar-panel"></i><span> PV Plant </span>
                </div>
                <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="wind_plant">
                    <i class="fas fa-wind"></i><span> Wind Plant </span>
                </div>
            </div>
            <h3>Energy Conversion</h3>
            <div>
                <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="transformer_station_in">
                    <i class="fas fa-arrow-left"></i><span> Transformer Station In </span>
                </div>
                <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="transformer_station_out">
                    <i class="fas fa-arrow-right"></i><span> Transformer Station Out </span>
                </div>
                <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="storage_charge_controller_in">
                    <i class="fas fa-charging-station"></i> <i class="fas fa-long-arrow-alt-left"></i><span> Storage Charge Controller In </span>
                </div>
                <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="storage_charge_controller_out">
                    <i class="fas fa-charging-station"></i> <i class="fas fa-long-arrow-alt-right"></i><span> Storage Charge Controller Out </span>
                </div>
                <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="solar_inverter">
                    <i class="fas fa-solar-panel"></i> <i class="fas fa-arrows-alt"></i><span> Solar Inverter </span>
                </div>
            </div>
            <h3>Energy Storage</h3>
            <div>
                <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="charging_power">
                    <i class="fas fa-battery-three-quarters"></i><span> Charging Power </span>
                </div>
                <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="discharging_power">
                    <i class="fas fa-battery-quarter"></i><span> Discharging Power </span>
                </div>
                <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="capacity">
                    <i class="fas fa-battery-full"></i><span> Capacity </span>
                </div>
            </div>
            <h3>Energy Consumption</h3>
            <div>
                <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="electricity_excess">
                    <i class="fas fa-fire"></i><span> Electricity Excess </span>
                </div>
                <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="dso_feedin">
                    <i class="fas fa-plug"></i><span> DSO Feedin </span>
                </div>
                <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="demand">
                    <i class="fas fa-lightbulb"></i><span> Demand </span>
                </div>
            </div>
            <h3>Energy Provider</h3>
            <div>
                <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="bus">
                    <i class="fas fa-grip-lines"></i><span> Bus </span>
                </div>
                <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="dso">
                    <i class="fas fa-grip-lines"></i><span> dso </span>
                </div>
                <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="requestModalWithNewDataEachTime">
                    <i class="fas fa-grip-lines"></i><span> Request from DB Test </span>
                </div>
            </div>

        </div>

        <div class="col-center">
            <div class="menu">
                <ul><li onclick="editor.changeModule('Home'); changeModule(event);" class="selected">Topology</li></ul>
            </div>

            <div id="drawflow" ondrop="drop(event)" ondragover="allowDrop(event)">
                <div class="btn-export" onclick="Swal.fire({title: 'Export', html: JSON.stringify(editor.export())})">
                    Export
                </div>
                <div class="btn-clear" onclick="editor.clearModuleSelected()">Clear</div>

                <div id="modal-div"></div>
            </div>
        </div>

        <!--
        <div class="col-right" style="display: none">
            Add here logic for the properties sidebar.
        </div>
        -->
    </div>

{% endblock topology %}


{% block end_body_scripts %}
    <script>
        /* Export Topology to JSON and send to back-end. */
        $(".btn-export").click(function(){
            $.ajax({
                headers: {'X-CSRFToken': '{{ csrf_token }}' },
                type: "POST",
                url: "{% url 'new_assets_topology' %}",
                data: JSON.stringify(editor.export()),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(resp){
                    var node = resp.data;
                    $.each(node, function(key, val){
                        // add database id to the node data dictionary, in order to discriminate among existing and new nodes.
                        editor.drawflow.drawflow.Home.data[`${key}`].data['databaseId'] = val;
                    });
                    },
                failure: function(errMsg) {alert(errMsg);}
            });
        });
    </script>

    <script>
        $( document ).ready(function() {
            $.getJSON("{% url 'new_assets_topology' %}", {}, function (data, textStatus, jqXHR){
                //console.log(`${JSON.stringify(busNodes)} \n\n and ${JSON.stringify(assetNodes)} \n\n and ${JSON.stringify(connectionLinks)}`);
                $.each(data['busses'], function (index, nodeData) {
                    createNodeObject(nodeData.name, 1, 1, nodeData.data, nodeData.pos_x, nodeData.pos_y);
                    //console.log(JSON.stringify(nodeData));
                });
                $.each(data['assets'], function (index, nodeData) {
                    createNodeObject(nodeData.name, 1, 1, nodeData.data, nodeData.pos_x, nodeData.pos_y);
                    //console.log(JSON.stringify(nodeData));
                });
                $.each(data['links'], function (index, linkData) {
                    let busNodeId = nodeToDbId[linkData.bus_id];
                    let assetNodeId = nodeToDbId[linkData.asset_id];

                    if (linkData.flow_direction === "B2A")
                        editor.addConnection(busNodeId, assetNodeId, 'output_1', 'input_1');
                    else
                        editor.addConnection(assetNodeId, busNodeId, 'output_1', 'input_1');
                    console.log(JSON.stringify(linkData));
                });
            })
            .done(function () { alert('Request done!'); })
            .fail(function (jqxhr,settings,ex) { alert('failed, '+ ex); });
        });
    </script>

    <script>
        // Initialize
        var id = document.getElementById("drawflow");
        const editor = new Drawflow(id);
        editor.reroute = true;
        //editor.drawflow = {"drawflow":{"Home":{"data":{"3":{"id":3,"name":"bus","data":{"name":"SDFSDF","bustype":"bus_heat"},"class":"bus","html":"Bus","typenode":false,"inputs":{"input_1":{"connections":[]}},"outputs":{"output_1":{"connections":[]}},"pos_x":309.41,"pos_y":311}}}}};
        editor.start();

        /* Mouse and Touch Actions */
        var elements = document.getElementsByClassName('drag-drawflow');
        for (var i = 0; i < elements.length; i++) {
            elements[i].addEventListener('touchend', drop, false);
            elements[i].addEventListener('touchmove', positionMobile, false);
            elements[i].addEventListener('touchstart', drag, false );
        }

        var mobile_item_selec = '';
        var mobile_last_move = null;
        function positionMobile(ev) {
            mobile_last_move = event;
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            if (ev.type === "touchstart") {
                mobile_item_selec = ev.target.closest(".drag-drawflow").getAttribute('data-node');
            } else {
                ev.dataTransfer.setData("node", ev.target.getAttribute('data-node'));
            }
        }

        function drop(ev) {
            if (ev.type === "touchend") {
                var parentdrawflow = document.elementFromPoint( mobile_last_move.touches[0].clientX, mobile_last_move.touches[0].clientY).closest("#drawflow");
                if(parentdrawflow != null) {
                    addNodeToDrawFlow(mobile_item_selec, mobile_last_move.touches[0].clientX, mobile_last_move.touches[0].clientY);
                }
                mobile_item_selec = '';
            } else {
                ev.preventDefault();
                var data = ev.dataTransfer.getData("node");
                addNodeToDrawFlow(data, ev.clientX, ev.clientY);
            }

        }

        // Disallow Any Connection to be created without a bus.
        editor.on('connectionCreated', function(connection) {
            var nodeIn = editor.getNodeFromId(connection['input_id']);
            var nodeOut = editor.getNodeFromId(connection['output_id']);
            if ((nodeIn['name'] !== 'bus' && nodeOut['name'] !== 'bus') || (nodeIn['name'] === 'bus' && nodeOut['name'] === 'bus')) {
                editor.removeSingleConnection(connection['output_id'],connection['input_id'],connection['output_class'],connection['input_class']);
                Swal.fire('Unexpected Connection', 'Please connect assets to each other\n only through a bus node. Interconnecting busses is also not allowed.', 'error')
            }
        })


        const nodeToDbId = {}; // a dictionary to keep the mapping between node and database ids.

        editor.on('nodeCreated', function (nodeID){
            const dbId = editor.drawflow.drawflow.Home.data[`${nodeID}`]['data']['databaseId'];
            nodeToDbId[`${dbId}`] = nodeID;
            //console.log('NodeCreated: ' + JSON.stringify(editor.drawflow.drawflow.Home.data[`${nodeID}`]));
        })

        function addNodeToDrawFlow(name, pos_x, pos_y) {
            if(editor.editor_mode === 'fixed') {
                return false;
            }
            pos_x = pos_x * ( editor.precanvas.clientWidth / (editor.precanvas.clientWidth * editor.zoom)) - (editor.precanvas.getBoundingClientRect().x * ( editor.precanvas.clientWidth / (editor.precanvas.clientWidth * editor.zoom)));
            pos_y = pos_y * ( editor.precanvas.clientHeight / (editor.precanvas.clientHeight * editor.zoom)) - (editor.precanvas.getBoundingClientRect().y * ( editor.precanvas.clientHeight / (editor.precanvas.clientHeight * editor.zoom)));

            createNodeObject(name, 1, 1, {}, pos_x, pos_y);
            /*
            switch (name) {
                case 'sourcethe':
                    let energy_source_html = `<div>
                        <div class="title-box">
                            <img src="/static/images/wind.png" style="max-width: 40%; max-height: 70%"/></i>Energy Source
                        </div>
                        <div class="box dbclickbox" ondblclick="showpopup(event)">
                            Db Click here
                            <div class="modal" style="display:none">
                              <div class="modal-content">
                                <span class="close" onclick="closemodal(event)">&times;</span>
                                Change your variable {name} !
                                <input type="text" df-name>
                              </div>

                            </div>
                        </div>
                    </div>`;
                    editor.addNode('sourceNodeName', 0,  1, pos_x, pos_y, 'sourcethe', { name: ''}, energy_source_html );
                    break;
                case 'transfmr':
                    var template = `
                          <div>
                            <div class="title-box"><i class="fas fa-code"></i><span>Transformer1</span></div>
                            <div class="box"><textarea df-template>Text</textarea>template info</div>
                          </div>
                          `;
                    editor.addNode('template', 1, 1, pos_x, pos_y, 'transfmr', { "transfmr": 'Write your template'}, template );
                    break;
                case 'requestModalWithNewDataEachTime':
                    var dbclick = `
            <div>
            <div class="title-box"><i class="fas fa-mouse"></i> Db Click</div>
              <div class="box clickbox" ondblclick="showcustompopup(event)">
                Db Click here

            <div id="demo" class="input-panel">
                <a class="btn btn-primary btn-lg open-modal" data-modal="CreateAssetModal">
                    Add Scenario
                </a>
            </div>

              </div>
            </div>
            `;
                    editor.addNode('dbclick', 1, 0, pos_x, pos_y, 'dbclick', { name: ''}, dbclick );
                    break;
                //<editor-fold desc="Energy Production">
                case 'dso_consumption':
                    createNodeObject('dso_consumption', 1, 1, 'dso_consumption', pos_x, pos_y);
                    break;
                case 'pv_plant':
                    createNodeObject('pv_plant', 1, 1, 'pv_plant', pos_x, pos_y);
                    break;
                case 'wind_plant':
                    createNodeObject('wind_plant', 1, 1, 'wind_plant', pos_x, pos_y);
                    break;
                //</editor-fold>
                //<editor-fold desc="Energy Conversion">
                case 'transformer_station_in':
                    createNodeObject('transformer_station_in', 1, 1, 'transformer_station_in', pos_x, pos_y);
                    break;
                case 'transformer_station_out':
                    createNodeObject('transformer', 1, 1, 'transformer_station_out', pos_x, pos_y);
                    break;
                case 'storage_charge_controller_in':
                    createNodeObject('transformer', 1, 1, 'storage_charge_controller_in', pos_x, pos_y);
                    break;
                case 'storage_charge_controller_out':
                    createNodeObject('transformer', 1, 1, 'storage_charge_controller_out', pos_x, pos_y);
                    break;
                case 'solar_inverter':
                    createNodeObject('transformer', 1, 1, 'solar_inverter', pos_x, pos_y);
                    break;
                //</editor-fold>
                //<editor-fold desc="Energy Storage">
                case 'charging_power':
                    createNodeObject('transformer', 1, 1, 'charging_power', pos_x, pos_y);
                    break;
                case 'discharging_power':
                    createNodeObject('transformer', 1, 1, 'discharging_power', pos_x, pos_y);
                    break;
                case 'capacity':
                    createNodeObject('transformer', 1, 1, 'capacity', pos_x, pos_y);
                    break;
                //</editor-fold>
                //<editor-fold desc="Energy Consumption">
                case 'electricity_excess':
                    createNodeObject('sink', 1, 1, 'electricity_excess', pos_x, pos_y);
                    break;
                case 'dso_feedin':
                    createNodeObject('sink', 1, 1, 'dso_feedin', pos_x, pos_y);
                    break;
                case 'demand':
                    createNodeObject('sink', 1, 1, 'demand', pos_x, pos_y);
                    break;
                //</editor-fold>
                //<editor-fold desc="Energy Provider">
                case 'bus':
                    createNodeObject('bus', 1, 1, 'dso', pos_x, pos_y);
                    break;
                case 'dso':
                    createNodeObject('dso', 1, 1, 'dso', pos_x, pos_y);
                    break;
                //</editor-fold>
                default:
            }
             */
        }


        let transform = '';
        function showpopup(e) {
            e.target.closest(".drawflow-node").style.zIndex = "9999";
            e.target.children[0].style.display = "block";
            console.log(e.target.children[0]);
            editor.precanvas.style.left = editor.canvas_x +'px';
            editor.precanvas.style.top = editor.canvas_y +'px';

            editor.editor_mode = "fixed";
        }

        function closemodal(e) {
            e.target.closest(".drawflow-node").style.zIndex = "2";
            e.target.parentElement.parentElement.style.display  ="none";
            editor.precanvas.style.left = '0px';
            editor.precanvas.style.top = '0px';
            editor.editor_mode = "edit";
        }

        function showcustompopup(e) {
            //modalData holds id of html form
            var modalDiv = $("#modal-div");
            var modalName = $(".open-modal").data("modal")


            $(".open-modal").on("click", function () {
                console.log("CLICKED!")
                $.ajax({
                    url: "{% url 'asset_create' 'pv_plant' %}",
                    success: function (data) {
                        modalDiv.html(data);

                        const inputs = document.getElementById('CreateAssetModal').getElementsByTagName('input');
                        for (const [key, value] of Object.entries(inputs)) {
                            console.log(key, value);
                        }
                        $('#' + modalName).modal();
                    }
                });
            });
        }
    </script>


    <script>

        // Define a uniqueIdIncrementor to keep track of the created object modals in the window.
        // For the creation procedure ids with names #modalDataId{0,1,2,3} are created.
        window.uniqueIdIncrementor = 0;

        function addInputAttributes(str) {
            /* this function loops over all form inputs and adds custom Drawflow attribute.
            *  It is equivalent to the python snippet added in the AssetForm Creation. */
            const parser = new DOMParser();
            let doc = parser.parseFromString(str, 'text/html');

            // get the list of all inputs and add the custom 'df-*' attribute foreach input
            let inputElements = doc.body.getElementsByTagName("input");
            $.each(inputElements, function(index, item){
                let nameAttr = item.getAttribute("name");
                item.setAttribute('df-'+nameAttr, '');
            });
            const theForm = doc.body.getElementsByTagName("form");
            return theForm;
        }

        function getAssetData(asset_type_name) {
            $.get('create/' + asset_type_name, function(data){
                let formData = data.substring(data.indexOf("<form "), data.indexOf("</form>") + 7);
                //data2Html = addInputAttributes(formData);
                $(`#modalDataId${uniqueIdIncrementor-1}`).html(formData);
                });
        }

        function createNodeObject(nodeName, connectionInputs=1, connectionOutputs=1, nodeData={}, pos_x, pos_y) {
            //console.log(`nodeName: ${nodeName} and asset_type_name: ${asset_type_name}.\n`);
            if (nodeName === 'bus'){
                let html = `<div class="box" ondblclick="showpopup(event)">
                <div class="modal" style="display:none">
                  <div class="modal-content">
                    <span class="close" onclick="closemodal(event)">&times;</span>
                    <div>
                        <label for="name">Name: </label>
                        <input id="name" type="text" df-name>
                    </div>
                    <div>
                        <label for="bustype">Bus Type: </label>
                        <select id="bustype" df-bustype>
                            <option value="" selected disabled hidden>Choose Type...</option>
                            <option value="bus_electricity">Electricity Bus</option>
                            <option value="bus_heat">Heat Bus</option>
                            <option value="bus_gas">Gas Bus</option>
                        </select>
                    </div>
                  </div>
                </div>
            </div>
            `;
            editor.addNode(nodeName, connectionInputs, connectionOutputs, pos_x, pos_y, nodeName, nodeData, html);
            }
            else {
                getAssetData(nodeName);
                let html = `<div class="box" ondblclick="showpopup(event)">
                <div class="modal" style="display:none">
                  <div class="modal-content">
                    <span class="close" onclick="closemodal(event)">&times;</span>
                    <div id="modalDataId${window.uniqueIdIncrementor++}"></div>
                  </div>
                </div>
            </div>
            `;
            editor.addNode(nodeName, connectionInputs, connectionOutputs, pos_x, pos_y, nodeName, nodeData, html);
            }
        }

        /* Use this function to create nodes which will contain the full html data (forms included). */
        // region Alternative Html Injection Implementation
        /*
        function createNodeObject(nodeName, connectionInputs=1, connectionOutputs=1, asset_type_name, pos_x, pos_y) {
            httpGetAsync(nodeName, connectionInputs, connectionOutputs, asset_type_name, pos_x, pos_y, createNodeDiv);
        }
        function createNodeDiv(nodeName, connectionInputs=1, connectionOutputs=1, pos_x, pos_y, innerHtmlData){
            console.log("innerHtmlData:         " + innerHtmlData);
            var source_html = `<div class="box" ondblclick="showpopup(event)">
                <div class="modal" style="display:none">
                  <div class="modal-content">
                    <span class="close" onclick="closemodal(event)">&times;</span>
                    <div id="modalDataId${window.uniqueIdIncrementor++}">${innerHtmlData}</div>
                  </div>
                </div>
            </div>
            `;
            editor.addNode(nodeName, connectionInputs, connectionOutputs, pos_x, pos_y, nodeName, {}, source_html);
            console.log(typeof(source_html));
            console.log(source_html);
        }

        function httpGetAsync(nodeName, connectionInputs=1, connectionOutputs=1, asset_type_name, pos_x, pos_y, callback)
        {
            console.log('Start Get Async');
            var fullUrl = 'create/' + asset_type_name;
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function() {
                if (xmlHttp.readyState == 4 && xmlHttp.status == 200){
                    var data = xmlHttp.responseText;
                    var formData = data.substring(data.indexOf("<form "), data.indexOf("</form>") + 7);
                    callback(nodeName, connectionInputs=1, connectionOutputs=1, pos_x, pos_y, formData);
                }
            }
            xmlHttp.open("GET", fullUrl, true); // true for asynchronous
            xmlHttp.send(null);

            console.log('End Get Async');
        }
         */
        // endregion
    </script>

{% endblock end_body_scripts %}
