{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block start_body_scripts %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.css">
<link rel="stylesheet" type="text/css" href="{% static 'css/beautiful.css' %}" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css"
    integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ=" crossorigin="anonymous" />
{% endblock start_body_scripts %}

{% block topology %}

<button onclick="window.history.back();" id="backbutton2">
    <span class="glyphicon glyphicon-chevron-left"></span> Back
</button>

<br>

<div class="wrapper">

    <div id="accordion" class="col">
        <h3 class="accordtitle">Energy Providers</h3>
        <ul style="list-style-type: none; padding: 0; height: auto;">
            <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="dso">
                <i class="fas fa-grip-lines"></i><span class="accordsubtitle"> System DSO </span>
            </li>
        </ul>
        <h3 class="accordtitle">Energy Production</h3>
        <ul style="list-style-type: none; padding: 0; height: auto;">
            <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="pv_plant">
                <i class="fas fa-solar-panel"></i><span class="accordsubtitle"> PV Plant </span>
            </li>
            <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="wind_plant">
                <i class="fas fa-wind"></i><span class="accordsubtitle"> Wind Plant </span>
            </li>
        </ul>
        <h3 class="accordtitle">Energy Conversion</h3>
        <ul style="list-style-type: none; padding: 0; height: auto;">
            <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="transformer_station_in">
                <i class="fas fa-arrow-left"></i><span class="accordsubtitle"> Transformer Station In </span>
            </li>
            <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="transformer_station_out">
                <i class="fas fa-arrow-right"></i><span class="accordsubtitle"> Transformer Station Out </span>
            </li>
            <li class="drag-drawflow" draggable="true" ondragstart="drag(event)"
                data-node="storage_charge_controller_in">
                <i class="fas fa-charging-station"></i> <i class="fas fa-long-arrow-alt-left"></i><span
                    class="accordsubtitle"> Storage Charge Controller In </span>
            </li>
            <li class="drag-drawflow" draggable="true" ondragstart="drag(event)"
                data-node="storage_charge_controller_out">
                <i class="fas fa-charging-station"></i> <i class="fas fa-long-arrow-alt-right"></i><span
                    class="accordsubtitle"> Storage Charge Controller Out </span>
            </li>
            <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="solar_inverter">
                <i class="fas fa-solar-panel"></i> <i class="fas fa-arrows-alt"></i><span class="accordsubtitle"> Solar
                    Inverter </span>
            </li>
            <br>
        </ul>
        <h3 class="accordtitle">Energy Storage</h3>
        <ul style="list-style-type: none; padding: 0; height: auto;">
            <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="storage_unit">
                <i class="fas fa-car-battery"></i><span class="accordsubtitle"> Storage </span>
            </li>
        </ul>
        <h3 class="accordtitle">Energy Consumption</h3>
        <ul style="list-style-type: none; padding: 0; height: auto;">
            <li class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="demand">
                <i class="fas fa-lightbulb"></i><span class="accordsubtitle"> Demand </span>
            </li>
        </ul>
        <h3 class="accordtitle">Energy Bus</h3>
        <ul style="list-style-type: none; padding: 0; height: auto;">
            <li>
                <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="bus">
                    <i class="fas fa-grip-lines"></i><span class="accordsubtitle"> Bus </span>
                </div>
            </li>
        </ul>
    </div>

    <div class="col-center">
        <div class="menu">
            <ul>
                <li onclick="editor.changeModule('Home'); changeModule(event);" class="selected">
                    Topology
                </li>
            </ul>
        </div>

        <div id="drawflow" ondrop="drop(event)" ondragover="allowDrop(event)">
            <div id="area-selection-div" hidden style="border: 1px dotted #000; position: absolute;"></div>
            <div class="btn-export">Save</div>
            <div class="btn-clear" onclick="editor.clearModuleSelected()">Clear</div>
        </div>
    </div>

</div>

{% endblock topology %}


{% block end_body_scripts %}

<script src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.serializeJSON/3.1.0/jquery.serializejson.min.js"
    integrity="sha512-4y8bsEzrXJqRyl2dqjdKk/DetH59JcFTtYNMsy5DUpvVV8CXiSrQ1gSCL3+dFgj1Xco0ONPizsYd6wX2eAXL2g=="
    crossorigin="anonymous"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script>
    $("#accordion").accordion({ collapsible: true, heightStyle: "content" });
</script>

<script>
    /* Script to retrieve nodes (assets and busses) and links data from the backend. */
    const addBusses = async (data) =>
        await Promise.all(data.map(async nodeData =>
            createNodeObject(nodeData.name, nodeData.input_ports, nodeData.output_ports, nodeData.data, nodeData.pos_x, nodeData.pos_y)));

    const addAssets = async (data) =>
        await Promise.all(data.map(async nodeData =>
            createNodeObject(nodeData.name, 1, 1, nodeData.data, nodeData.pos_x, nodeData.pos_y)));

    const addLinks = async (data) => data.map(async linkData => {
        let busNodeId = nodeToDbId['bus'][linkData.bus_id];
        let assetNodeId = nodeToDbId['asset'][linkData.asset_id];
        (linkData.flow_direction === "B2A") ?
            editor.addConnection(busNodeId, assetNodeId, linkData.bus_connection_port, 'input_1')
            : editor.addConnection(assetNodeId, busNodeId, 'output_1', linkData.bus_connection_port);
    });

    $(window).on('load', function () {
        $.getJSON("{% url 'new_assets_topology' scenario_id %}", {}, async (data, textStatus, jqXHR) => {
            $.when(addBusses(data['busses']), addAssets(data['assets']))
                .then(async () => addLinks(data['links'])); // endwhen
            return data;
        })
            .done(function (data) { /*console.log(`Finished loading nodes and links! ${JSON.stringify(data)}`);*/
            })
            .fail(function (jqxhr, settings, ex) {
                alert('failed, ' + ex);
            });
    });
</script>


<script>
    // Initialize Drawflow
    var id = document.getElementById("drawflow");
    const editor = new Drawflow(id);
    editor.reroute = true;
    editor.start();
    // editor.drawflow.drawflow.Home.data; // All node level data are saved here

    /* Mouse and Touch Actions */
    var elements = document.getElementsByClassName('drag-drawflow');
    for (var i = 0; i < elements.length; i++) {
        elements[i].addEventListener('touchend', drop, false);
        elements[i].addEventListener('touchmove', positionMobile, false);
        elements[i].addEventListener('touchstart', drag, false);
    }

    var mobile_item_selec = '';
    var mobile_last_move = null;

    function positionMobile(ev) {
        mobile_last_move = event;
    }

    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(ev) {
        if (ev.type === "touchstart") {
            mobile_item_selec = ev.target.closest(".drag-drawflow").getAttribute('data-node');
        } else {
            ev.dataTransfer.setData("node", ev.target.getAttribute('data-node'));
        }
    }

    function drop(ev) {
        if (ev.type === "touchend") {
            const parentdrawflow = document.elementFromPoint(mobile_last_move.touches[0].clientX, mobile_last_move.touches[0].clientY).closest("#drawflow");
            if (parentdrawflow != null) {
                addNodeToDrawFlow(mobile_item_selec, mobile_last_move.touches[0].clientX, mobile_last_move.touches[0].clientY);
            }
            mobile_item_selec = '';
        } else {
            ev.preventDefault();
            const nodeName = ev.dataTransfer.getData("node");
            (nodeName === "bus") ? IOBusOptions(nodeName, ev.clientX, ev.clientY) :
                (nodeName === "storage_unit") ? addStorageUnit(nodeName, ev.clientX, ev.clientY) : addNodeToDrawFlow(nodeName, ev.clientX, ev.clientY);
        }
    }


    // region create Storage Unit - template
    const addStorageUnit = async (nodeName /* i.e. storage_unit */, clientX, clientY) => {
        // Solution 1: Use a JSON file to autogenerate nodes semi-agnostic each time. Links are hand created.
        // Alternative Solution: Create a template using the UI and export the JSON.
        // Hardcode the JSON in separate file or here and parametrize.
        // Finally Use async/await and addBusses(), addAssets(), addLinks() functions to show template.

        const storageUnitData = {
            "busses": [
                {
                    "name": "bus", "data": { "name": "storage bus", "bustype": "Electricity", "parent_asset_id": 0 },
                    "pos_x": clientX, "pos_y": clientY, "input_ports": 2, "output_ports": 1
                }],
            "assets": [
                {
                    "name": "ess",
                    "pos_x": clientX - 145,
                    "pos_y": clientY - 125,
                    "data": { "name": "ESS1" }
                },
                {
                    "name": "charging_power",
                    "pos_x": clientX - 140,
                    "pos_y": clientY - 90,
                    "data": {
                        "parent_asset_id": 0,
                        "name": "Charge",
                        "age_installed": 0,
                        "installed_capacity": 100,
                        "capex_fix": 2,
                        "capex_var": 2,
                        "opex_fix": 2,
                        "opex_var": 2,
                        "lifetime": 10,
                        "crate": 0.2,
                        "efficiency": 0.9,
                        "dispatchable": false
                    }
                },
                {
                    "name": "discharging_power",
                    "pos_x": clientX + 160,
                    "pos_y": clientY - 90,
                    "data": {
                        "parent_asset_id": 0,
                        "name": "DIscharge",
                        "age_installed": 0,
                        "installed_capacity": 500,
                        "capex_fix": 2,
                        "capex_var": 2,
                        "opex_fix": 2,
                        "opex_var": 2,
                        "lifetime": 2,
                        "crate": 1,
                        "efficiency": 0.9,
                        "dispatchable": false,
                    }
                },
                {
                    "name": "capacity",
                    "pos_x": clientX - 140,
                    "pos_y": clientY + 90,
                    "data": {
                        "parent_asset_id": 0,
                        "name": "Cap",
                        "age_installed": 0,
                        "installed_capacity": 500,
                        "capex_fix": 2,
                        "capex_var": 200,
                        "opex_fix": 2,
                        "opex_var": 2,
                        "lifetime": 10,
                        "optimize_cap": true,
                        "efficiency": 0.999,
                        "soc_max": 1,
                        "soc_min": 0.2,
                        "dispatchable": false
                    }
                }],
            "links": [
                { "bus_id": null, "asset_id": null, "flow_direction": "B2A", "bus_connection_port": "output_1" },
                { "bus_id": null, "asset_id": null, "flow_direction": "A2B", "bus_connection_port": "input_1" },
                { "bus_id": null, "asset_id": null, "flow_direction": "A2B", "bus_connection_port": "input_2" }]
        };

        const busses_dict = await addBusses(storageUnitData['busses']);
        const assets_dict = await addAssets(storageUnitData['assets']);
        const essAsset = assets_dict.find(a => a.specificNodeType === "ess"); // find the ess storage asset
        // Add ESS nodeId to each node of the storage unit
        editor.drawflow.drawflow.Home.data[busses_dict[0].editorNodeId].data.parent_asset_id = essAsset.editorNodeId;
        assets_dict.map(item => {
            if (item.specificNodeType !== "ess")
                editor.drawflow.drawflow.Home.data[item.editorNodeId].data.parent_asset_id = essAsset.editorNodeId;
        });
        // Create DrawFlow Connections
        assets_dict.map(item => {
            if (item.specificNodeType === "charging_power") {
                editor.addConnection(item.editorNodeId, busses_dict[0].editorNodeId, 'output_1', 'input_1');
            } else if (item.specificNodeType === "discharging_power") {
                editor.addConnection(busses_dict[0].editorNodeId, item.editorNodeId, 'output_1', 'input_1');
            } else if (item.specificNodeType === "capacity") {
                editor.addConnection(item.editorNodeId, busses_dict[0].editorNodeId, 'output_1', 'input_2')
            } else {
                /* it is the ess asset */
            }
        });

        /* // Solution 2: Specifically define assets, busses and connections foreach template.
        const storageBusNodeId = await addNodeToDrawFlow("bus", clientX, clientY, 2, 1);
        const storageChargingPowerId = await addNodeToDrawFlow("charging_power", clientX+100, clientY+20, 1, 1);
        const storageDischargingPowerId = await addNodeToDrawFlow("discharging_power", clientX+100, clientY+80, 1, 1);
        const storageCapacityId = await addNodeToDrawFlow("capacity", clientX-150, clientY+50, 0, 1);

        // Add Connections between Nodes.
        editor.addConnection(storageChargingPowerId, storageBusNodeId, 'output_1', 'input_1');
        editor.addConnection(storageBusNodeId, storageDischargingPowerId, 'output_1', 'input_1');
        editor.addConnection(storageCapacityId, storageBusNodeId, 'output_1', 'input_2');
        */
    }

    // endregion create Storage Unit - template


    function IOBusOptions(nodeName, posX, posY) {
        const checkMinMax = (value, min, max) => (value <= min) ? min : (value >= max) ? max : value;
        Swal.mixin({
            input: 'number',
            confirmButtonText: 'Next',
            showCancelButton: true,
            progressSteps: ['1', '2']
        })
            .queue([
                {
                    title: 'Bus Inputs',
                    text: 'Provide the number of bus Inputs (default 1)',
                    //html: '<div>Testing Here</div>'
                },
                {
                    title: 'Bus Outputs',
                    text: 'Provide the number of bus Outputs (default 1)',
                }
            ])
            .then((result) => {
                if (result.value) {
                    const inputs = checkMinMax(result.value[0], 1, 7);
                    const outputs = checkMinMax(result.value[1], 1, 7);
                    addNodeToDrawFlow(nodeName, posX, posY, inputs, outputs);
                }
            })
    }

    // Disallow Any Connection to be created without a bus.
    editor.on('connectionCreated', function (connection) {
        var nodeIn = editor.getNodeFromId(connection['input_id']);
        var nodeOut = editor.getNodeFromId(connection['output_id']);
        if ((nodeIn['name'] !== 'bus' && nodeOut['name'] !== 'bus') || (nodeIn['name'] === 'bus' && nodeOut['name'] === 'bus')) {
            editor.removeSingleConnection(connection['output_id'], connection['input_id'], connection['output_class'], connection['input_class']);
            Swal.fire('Unexpected Connection', 'Please connect assets to each other\n only through a bus node. Interconnecting busses is also not allowed.', 'error')
        }
    })

    const nodeToDbId = { 'bus': {}, 'asset': {} }; // a dictionary to keep the mapping between node and database ids.

    editor.on('nodeCreated', function (nodeID) {
        // region add new node to mapping dictionary
        const nodeType = (editor.drawflow.drawflow.Home.data[`${nodeID}`].name === "bus") ? "bus" : "asset";
        const dbId = editor.drawflow.drawflow.Home.data[`${nodeID}`]['data']['databaseId'];
        if (nodeType === "bus")
            nodeToDbId['bus'][`${dbId}`] = nodeID;
        else {
            nodeToDbId['asset'][`${dbId}`] = nodeID;
        }
        // endregion
        // region bind installed_capacity to age_installed Changes
        const nodeIdInstalledCapInput = document.getElementById(`node-${nodeID}`).querySelector("input[name='installed_capacity']");
        if (nodeIdInstalledCapInput) {
            nodeIdInstalledCapInput.addEventListener('change', function (e) {
                const ageInstalledElement = e.target.closest("#FormGroup").querySelector("input[name='age_installed']");
                if (e.target.value === '0') {
                    ageInstalledElement.value = '0';
                    ageInstalledElement.readOnly = true;
                    /* Drawflow listens for input event to update df-*. - check editor.updateNodeValue(e); */
                    /* Solution #1: add age-installed value directly to the JSON */
                    /* Solution #2: create an Event and dispatch it to the input without user interaction */
                    // #1: editor.drawflow.drawflow.Home.data[`${nodeID}`].data['age_installed'] = 0; // hot fix, write directly to drawflow data.
                    // #2: below
                    let notifyAgeInputEvent = new Event("input", { bubbles: true });
                    ageInstalledElement.dispatchEvent(notifyAgeInputEvent);
                }
                else
                    ageInstalledElement.readOnly = false;
            });
            // for existing nodes check if installed cap is zero and set age_installed to read only
            if (nodeIdInstalledCapInput.value === '0')
                nodeIdInstalledCapInput.closest("#FormGroup").querySelector("input[name='age_installed']").readOnly = true;
        }
        // endregion
        // region Add Tooltip to the inputs of each node
        //$("input[data-toggle='tooltip']").on('focus', function () {
        //    $(this).tooltip('show');
        //});
        // endregion
    })

    async function addNodeToDrawFlow(name, pos_x, pos_y, nodeInputs = 1, nodeOutputs = 1, nodeData = {}) {
        if (editor.editor_mode === 'fixed')
            return false;
        pos_x = pos_x * (editor.precanvas.clientWidth / (editor.precanvas.clientWidth * editor.zoom)) - (editor.precanvas.getBoundingClientRect().x * (editor.precanvas.clientWidth / (editor.precanvas.clientWidth * editor.zoom)));
        pos_y = pos_y * (editor.precanvas.clientHeight / (editor.precanvas.clientHeight * editor.zoom)) - (editor.precanvas.getBoundingClientRect().y * (editor.precanvas.clientHeight / (editor.precanvas.clientHeight * editor.zoom)));
        return createNodeObject(name, nodeInputs, nodeOutputs, {}, pos_x, pos_y);
    }

    // region Show Modal either by double clicking the box or the drawflow node.
    var transform = '';

    document.addEventListener("dblclick", function (e) {
        const openModal = function (box) {
            box.closest(".drawflow-node").style.zIndex = "9999";
            box.children[0].style.display = "block";
            transform = editor.precanvas.style.transform;
            editor.precanvas.style.transform = '';
            editor.precanvas.style.left = editor.canvas_x + 'px';
            editor.precanvas.style.top = editor.canvas_y + 'px';
            editor.editor_mode = "fixed";
        }

        const NodeList = document.getElementsByClassName("drawflow-node");
        for (const node of NodeList) {
            let nodeContent = node.querySelector('.drawflow-node .drawflow_content_node');
            if (e.target === node) {
                const box = e.target.querySelector('.drawflow-node .box');
                openModal(box);
            }
            else if (e.target === nodeContent) {
                const box = e.target.querySelector('.drawflow_content_node .box');
                openModal(box);
            }
            // do the same if .box is clicked
            else if (e.target === node.querySelector('.drawflow-node .box')) {
                openModal(e.target);
            }
        }
    });
    // endregion

    // region close Modal on: 1. click 'x', 2. press 'esc' and 3. click outside the modal.
    function closeModalSteps(modal) {
        // // Change the name of the node based on input
        const nodeNameElem = modal.closest('.drawflow_content_node').querySelector('.nodeName');
        nodeNameElem.textContent = `${modal.querySelector('input[df-name]').value}`;
        // End name change

        modal.style.display = "none"; // hide the modal
        modal.closest(".drawflow-node").style.zIndex =
            (modal.closest(".drawflow-node").classList.contains("ess")) ? "1" : "2"; // bring node to default z-index
        editor.precanvas.style.transform = transform;
        editor.precanvas.style.left = '0px';
        editor.precanvas.style.top = '0px';
        editor.editor_mode = "edit";
    }

    const closemodal = (e) => closeModalSteps(e.target.closest(".modal"));

    document.addEventListener('keydown', function (e) {
        const modalList = document.getElementsByClassName("modal");
        if (e.keyCode === 27) {
            for (let modalDiv of modalList) {
                if (modalDiv.style.display === "block")
                    closeModalSteps(modalDiv);
            }
        }
    })

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function (e) {
        const modalList = document.getElementsByClassName("modal");
        for (const modalDiv of modalList) {
            if (e.target === modalDiv && modalDiv.style.display === "block")
                closeModalSteps(modalDiv);
        }
    }
        // endregion set

        // region multiple items selection
        //
    /*
    var div = document.getElementById('area-selection-div'), x1 = 0, y1 = 0, x2 = 0, y2 = 0;
    function reCalc() {
        var x3 = Math.min(x1,x2);
        var x4 = Math.max(x1,x2);
        var y3 = Math.min(y1,y2);
        var y4 = Math.max(y1,y2);
        div.style.left = x3 + 'px';
        div.style.top = y3 + 'px';
        div.style.width = x4 - x3 + 'px';
        div.style.height = y4 - y3 + 'px';
    }

    onmousedown = function(e) {
        div.hidden = 0;
        x1 = e.clientX;
        y1 = e.clientY;
        reCalc();
    };
    onmousemove = function(e) {
        x2 = e.clientX;
        y2 = e.clientY;
        reCalc();
    };
    onmouseup = function(e) {
        div.hidden = 1;
    };

    ////////////
    let log = document.querySelector('#area-selection-div');
    document.addEventListener('click', logKey);

    function logKey(e) {
        log.textContent = `The ctrl key is pressed: ${e.ctrlKey}`;
    }
    */
        // endregion
</script>

<script>
    async function createNodeObject(nodeName, connectionInputs = 1, connectionOutputs = 1, nodeData = {}, pos_x, pos_y) {
        if (nodeName === "bus") {
            const shownName = (typeof nodeData.name === 'undefined') ? nodeName : nodeData.name;
            let html = `<div class="box">
                <div class="modal" style="display:none">
                  <div class="modal-content">
                    <span class="close" onclick="closemodal(event)">&times;</span>
                    <h2 text-align: left" class="panel-heading">${nodeName} Properties</h2><br><br>
                    <div class="row">
                        <div class="col-md-1"></div>
                        <div class="col-md-3">
                        <label for="name" style="font-weight: 600; text-transform: uppercase; color:#1c1c1c; opacity: 0.9;">Name: </label>
                        </div>
                        <div class="col-md-7">
                        <input id="name" style="font-size:13px; font-weight:400;" type="text" df-name>
                        </div>
                    </div><br><br>
                    <div  class="row">
                        <div class="col-md-1"></div>
                        <div class="col-md-3">
                        <label for="bustype" style="font-weight: 600; text-transform: uppercase; color:#1c1c1c; opacity: 0.9;">Energy carrier: </label>
                        </div>
                        <div class="col-md-7">
                        <select id="bustype" style="font-size:13px; font-weight:400;" df-bustype>
                            <option value="" selected disabled hidden>Choose Type...</option>
                            <option value="Electricity">Electricity Bus</option>
                            <option value="Heat">Heat Bus</option>
                            <option value="Gas">Gas Bus</option>
                            <option value="H2">H2 Bus</option>
                            <option value="Diesel">Diesel Bus</option>
                        </select>
                        </div>
                    </div>
                    <button style="background-color: #0ac2b2; margin: 3% 30%; width: 30%; display: block;
                            font-size: medium; font-family: century gothic" onclick="closemodal(event)">Ok</button>
                  </div>
                </div>
            </div>
            <div class="nodeName" style="color: black;">${shownName}</div>`;
            return {
                "editorNodeId": editor.addNode(nodeName, connectionInputs, connectionOutputs, pos_x, pos_y, nodeName, nodeData, html),
                "specificNodeType": nodeName
            };
        } else
            return fetchAssetForm(nodeName, connectionInputs, connectionOutputs, nodeData, pos_x, pos_y);
    }

    async function fetchAssetForm(nodeName, connectionInputs = 1, connectionOutputs = 1, nodeData, pos_x, pos_y) {
        // Due to a problem with Boolean Values not showing in the modal we have to convert bool to string.
        const trueFalseNullSelector = (param) => (param) ? "True" : (param == false ? "False" : undefined);
        //console.log(`${nodeData.name} => ${nodeData.optimize_cap}`);
        nodeData.optimize_cap = trueFalseNullSelector(nodeData.optimize_cap);
        nodeData.dispatchable = trueFalseNullSelector(nodeData.dispatchable);
        nodeData.renewable_asset = trueFalseNullSelector(nodeData.renewable_asset);

        // ------------------------------------------------------------------------------------------------
        const fullUrl = document.location.origin + '/asset/create/' + nodeName;

        const resp = await fetch(fullUrl);
        const data = await resp.text();
        const formData = data.substring(data.indexOf("<form "), data.indexOf("</form>") + 7);

        const shownName = (typeof nodeData.name === 'undefined') ? nodeName : nodeData.name;
        const source_html = `<div class="box">
                <div class="modal" style="display:none">
                  <div class="modal-content">
                    <span class="close" onclick="closemodal(event)">&times;</span>
                    <br>
                    <h2 class="panel-heading" text-align: left">${nodeName.replaceAll("_", " ")} Properties</h2>
                    <br>
                    <div class="row">
                    <div class="col-md-1"></div>
                    <div class="col-md-10">
                        ${formData}
                    </div>
                    </div>
                    <button style="background-color: #0ac2b2; margin: auto; width: 30%; display: block;
                            font-size: medium; font-family: century gothic" onclick="closemodal(event)">Ok</button>
                  </div>
                </div>
            </div>
            <div class="nodeName" style="color: black;">${shownName}</div>`;

        return {
            "editorNodeId": editor.addNode(nodeName, connectionInputs, connectionOutputs, pos_x, pos_y, nodeName, nodeData, source_html),
            "specificNodeType": nodeName
        };
    }

</script>

<script defer>
    /* Export Topology to JSON and send to back-end. */
    $(".btn-export").click(function () {
        // Data Pre-check
        /* 
        /* Check if there are duplicate node names in the model
        /* and prevent user from saving the model if there are.
        */
        data = editor.export().drawflow.Home.data;
        node_list = Object.values(data)
        node_names = node_list.map(obj => obj.data.name);
        duplicate_names = node_names.filter((name, i, a) => a.indexOf(name) !== i)

        if (duplicate_names.length != 0)
            return Swal.fire('Grid Model Error',
                `There are nodes with duplicate names. \n Rename nodes with names: ${duplicate_names.toString()}`, 'error');
        // End Data Pre-check
        else {
            $.ajax({
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                type: "POST",
                url: "{% url 'new_assets_topology' scenario_id %}",
                data: JSON.stringify(editor.export()),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (resp) {
                    var node = resp.data;
                    $.each(node, function (key, val) {
                        // add database id to the node data dictionary, in order to discriminate among existing and new nodes.
                        editor.drawflow.drawflow.Home.data[`${key}`].data['databaseId'] = val;
                    });
                    window.location.href = "{% url 'scenario_search' project_id %}";
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    const jsonData = XMLHttpRequest.responseJSON;
                    if (jsonData.specific_obj_type) {
                        Swal.fire('Grid Model Error', `Please fill in all ${jsonData.specific_obj_type.bold()} fields. \n
                       Asset ${jsonData.obj_name.bold()} has empty fields.`, 'error');
                    }
                    else {
                        Swal.fire('Grid Model Error', `Asset ${jsonData.obj_name.bold()} has empty fields.`, 'error');
                    }
                }
            });
        }
    });
</script>

{% endblock end_body_scripts %}